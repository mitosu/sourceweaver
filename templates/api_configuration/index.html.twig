{% extends 'base.html.twig' %}

{% block title %}Configuración de APIs - IRONWHISPER{% endblock %}

{% block main_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">API OSINT de FastAPI</h1>
                <p class="text-muted mb-0">Microservicio Python para análisis de inteligencia</p>
            </div>
            <div class="d-flex gap-2">
                <a href="http://localhost:8001/openapi.json" 
                   class="btn btn-outline-primary" 
                   target="_blank"
                   title="Descargar especificación OpenAPI/Swagger">
                    <i class="bi bi-download me-1"></i>Descargar Swagger
                </a>
                <a href="http://localhost:8001/docs" 
                   class="btn btn-outline-info" 
                   target="_blank"
                   title="Abrir documentación interactiva">
                    <i class="bi bi-book me-1"></i>Documentación
                </a>
            </div>
        </div>

        <!-- FastAPI OSINT Service Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card border-success">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0 text-success">
                            <i class="bi bi-check-circle me-2"></i>FastAPI OSINT Microservice
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">
                            Microservicio Python desarrollado con FastAPI que proporciona múltiples herramientas 
                            de OSINT integradas para análisis de inteligencia de fuentes abiertas.
                        </p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-tools me-2"></i>Herramientas Disponibles:</h6>
                                <ul class="list-unstyled mb-3">
                                    <li><i class="bi bi-shield-check text-primary me-2"></i>VirusTotal</li>
                                    <li><i class="bi bi-search text-primary me-2"></i>Google Search</li>
                                    <li><i class="bi bi-person-badge text-primary me-2"></i>Alias/Social Media Search</li>
                                    <li><i class="bi bi-binoculars text-primary me-2"></i>Advanced Dorking</li>
                                    <li><i class="bi bi-person-exclamation text-primary me-2"></i>HaveIBeenPwned</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-bullseye me-2"></i>Tipos de Target Soportados:</h6>
                                <ul class="list-unstyled mb-3">
                                    <li><i class="bi bi-hdd-network text-info me-2"></i>Direcciones IP</li>
                                    <li><i class="bi bi-globe text-info me-2"></i>Dominios</li>
                                    <li><i class="bi bi-link-45deg text-info me-2"></i>URLs</li>
                                    <li><i class="bi bi-envelope text-info me-2"></i>Emails</li>
                                    <li><i class="bi bi-fingerprint text-info me-2"></i>Hashes</li>
                                    <li><i class="bi bi-person-badge text-info me-2"></i>Alias/Usernames</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-activity me-2"></i>Estado del Servicio
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Estado:</span>
                            <span class="badge bg-success" id="api-status">
                                <i class="bi bi-check-circle me-1"></i>Activo
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Puerto:</span>
                            <code>8001</code>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Protocolo:</span>
                            <code>HTTP</code>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="checkApiHealth()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Verificar Estado
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Endpoints Information -->
        {% set fastapi_endpoints = [
            {
                'path': '/health',
                'method': 'GET',
                'description': 'Verificación de salud del servicio',
                'category': 'Sistema'
            },
            {
                'path': '/api/v1/virustotal/*',
                'method': 'GET/POST',
                'description': 'Análisis con VirusTotal',
                'category': 'OSINT'
            },
            {
                'path': '/api/v1/google-search/*',
                'method': 'GET',
                'description': 'Búsquedas de Google',
                'category': 'OSINT'
            },
            {
                'path': '/api/v1/alias-search/*',
                'method': 'GET/POST',
                'description': 'Búsqueda de alias en redes sociales',
                'category': 'OSINT'
            },
            {
                'path': '/api/v1/dorking/*',
                'method': 'GET',
                'description': 'Google Dorking avanzado',
                'category': 'OSINT'
            },
            {
                'path': '/haveibeenpwned/*',
                'method': 'GET',
                'description': 'Verificación de brechas de seguridad',
                'category': 'OSINT'
            }
        ] %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>Endpoints Disponibles
                </h5>
                <small class="text-muted">Endpoints de la API FastAPI OSINT en puerto 8001</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Endpoint</th>
                                <th>Método</th>
                                <th>Descripción</th>
                                <th>Categoría</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for endpoint in fastapi_endpoints %}
                                <tr>
                                    <td>
                                        <code class="bg-light px-2 py-1 rounded">{{ endpoint.path }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if endpoint.method == 'GET' %}primary{% elseif endpoint.method == 'POST' %}success{% else %}info{% endif %}">
                                            {{ endpoint.method }}
                                        </span>
                                    </td>
                                    <td>{{ endpoint.description }}</td>
                                    <td>
                                        <span class="badge {% if endpoint.category == 'Sistema' %}bg-secondary{% else %}bg-warning{% endif %}">
                                            {{ endpoint.category }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>Activo
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-8">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Para más detalles sobre cada endpoint, consulta la 
                                <a href="http://localhost:8001/docs" target="_blank">documentación interactiva</a> de FastAPI.
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                Base URL: <code>http://localhost:8001</code>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
// Function to check FastAPI health status
function checkApiHealth() {
    const statusElement = document.getElementById('api-status');
    const originalHtml = statusElement.innerHTML;
    const button = event.target;
    const originalButtonHtml = button.innerHTML;
    
    // Show loading state
    statusElement.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Verificando...';
    statusElement.className = 'badge bg-warning';
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verificando...';
    button.disabled = true;
    
    // Check FastAPI health endpoint
    fetch('http://localhost:8001/health', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'healthy') {
            statusElement.innerHTML = '<i class="bi bi-check-circle me-1"></i>Activo';
            statusElement.className = 'badge bg-success';
            
            // Show detailed info in console for debugging
            console.log('FastAPI Health Check:', data);
            
            // Optional: Show success message
            setTimeout(() => {
                alert('✅ API FastAPI está funcionando correctamente\n\n' + 
                      'Servicio: ' + data.service + '\n' + 
                      'Versión: ' + data.version + '\n' +
                      'Servicios disponibles: ' + Object.keys(data.services || {}).length);
            }, 100);
        } else {
            throw new Error('API devolvió estado no saludable');
        }
    })
    .catch(error => {
        statusElement.innerHTML = '<i class="bi bi-x-circle me-1"></i>Inactivo';
        statusElement.className = 'badge bg-danger';
        
        console.error('FastAPI Health Check Error:', error);
        
        // Show error message
        setTimeout(() => {
            alert('❌ No se pudo conectar con la API FastAPI\n\n' + 
                  'Error: ' + error.message + '\n\n' +
                  'Verifica que el contenedor Python esté ejecutándose en el puerto 8001.');
        }, 100);
    })
    .finally(() => {
        // Reset button state
        button.innerHTML = originalButtonHtml;
        button.disabled = false;
    });
}

// Check API health on page load
document.addEventListener('DOMContentLoaded', function() {
    // Auto-check API health when page loads
    setTimeout(checkApiHealth, 1000);
});

// Refresh page every 30 seconds to keep status updated
setInterval(function() {
    // Only auto-refresh if not manually checking
    const button = document.querySelector('button[onclick="checkApiHealth()"]');
    if (button && !button.disabled) {
        checkApiHealth();
    }
}, 30000);
</script>
{% endblock %}